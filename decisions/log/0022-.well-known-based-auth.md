# 22. Pathfinder .well-known-based Endpoint discovery (Proposal #2)

Date: 2023-09-13

## Status

Proposed

## Context

1. PACT members mentioned challenges in integrating the authentication endpoint (Action `Authenticate` in Tech Specs speak) with their **existing** authentication infratructure
    1. one reason is that these systems are operated in a special way under pathes and endpoints that cannot easily be modified or adapted
    2. yet another reason is how the Tech Specs specify the path to the `Authenticate` action ; namely, it is hardcoded as follows: `AuthSubPath/auth/token` with `/auth/token` being fixed.
    3. To exemplify why this specification is an issue: image the URL of an ********existing******** OAuth2 endpoint was `https://some-domain.com/oauth/token` or`https://some-domain.com/token` ; none such endpoints would be conforming to the current tech specs
2. Additionally, the `Authenticate` Action is the same for V1 and V2 series
3. Last, but not least: any update to the Action Authenticate’s path would break backwards-compatibility

## Decision

### Summary

1. An OPTIONAL but RECOMMENDED `Pathfinder Discovery Mechanism` is defined which supports Data Recipients to discover endpoints more easily
    1. the discovery mechanism is based on a `.well-known/pathfinder` file 
    2. the discovery mechanism supports optional overwriting of the URL (likewise `AuthHostname` and `AuthSubpath` in current Tech Specs speak) to the `Authenticate` endpoint
2. The Authentication logic, to be executed by Data Recipients, is updated to add mandatory support for the `Pathfinder Discovery Mechanism` such that
    1. Version 2.1 data recipients are fully interoperable with Version 2.0 data owners,
    2. and likewise Version 2.0 data recipients can fully interact with Version 2.1 data owners as long as the Version 2.1 data owners offer a fully working `Authenticate` endpoint as specified in Tech Specs V2.0.x
3. Given the nature of this change, Tech Specs Version must be updated from 2.0.x to 2.1.y

*The mechanism proposed is extensible so that data recipients are able to discover additional endpoints or additional functionality in the future as the Technical Specifications progress.*

### Example

A Host System makes a `.well-known/pathfinder` document available

```javascript
GET /subpath/.well-known/pathfinder HTTP/1.1
Host: solution.com

HTTP/1.1 200 OK
Content-Type: application/json

{
	"basepath": "https://api.solution.com/",
	"authenticate_endpoint": "https://idp.solution.com/oauth/token"
}
```

[Comment: `subpath` is OPTIONAL and is only added for demonstrative purposes]

The document contains the URLs needed to retrieve tokens for Authentication (property `authenticate_endpoint` and also contains the `basepath` URL to access other Pathfinder conforming HTTP Actions `ListFootprints` and `GetFootprint`.

Through the `basepath` URL, a Data Recipient can access the `ListFootprints` action through URL `https://api.solution.com/2/footprints` after successful Authentication through `authenticate_endpoint`.

### Technical Details

1. With version 2.1 a Host System SHOULD support the `Pathfinder Discovery Mechanism` by making `Pathfinder Discovery Configuration Document` available under a `Discovery Base URL`  conforming with the following specifications:
    1. The Host System MUST make a JSON document available at the path formed by concatenating the string `/.well-known/pathfinder` to the `Discovery Base URL`
2. The `Pathfinder Discovery Configuration Document` (`/.well-known/pathfinder`) 
    1. MUST be returned using the `application/json` content type
    2. MUST be a JSON Object with the following properties (all are REQUIRED):
        1. `basepath` URL using the `https` scheme used as the Host System’s API base path
        2.  `authenticate_endpoint` URL using the `https` scheme specifying the `Action Authenticate` endpoint. This endpoint can either follow the Tech Specs Version 2.0 authentication method (i.e. following syntax: `AuthSubPath/auth/token`) or another syntax, as long as the action is implemented in comformance with  [[rfc6749]](https://www.rfc-editor.org/rfc/rfc6749) Section 4.4 (OAuth2 Client Credentials).
3. The Authentication logic is added and updated as follows:
    1. A Version 2.1 Data recipient before Authenticating, MUST request the `Pathfinder Discovery Configuration Document` from a Host System before making calls to any `authenticate` endpoint
    2. If such a document is found, the Data Recipient MUST retrieve a Bearer token from the endpoint defined in the `authenticate_endpoint` property of the `Pathfinder Discovery Configuration Document` retrieved
    3. If such a document is not found, the Data Recipient SHOULD attempt to authenticate using the Tech Specs Version 2.0 authentication method (i.e. following syntax: `AuthSubPath/auth/token`)

### Consequences

- New `2.1` version release needs to be published. This requires a feedback period and will take approximately 4 weeks after acceptance of this ADR
- WBCSD, SINE, and/or other parties should register the .well-known entry in the IANA Well-Known URI registry (see RFC5785 Section 5.1) for RFC5785 conformance
- Implementers of Version 2.0 are encouraged to upgrade their implementation to Version 2.1
    - this implies they undergo Conformance testing with 2.1 partners as well
- If a Data Recipient and the Data Owner support Tech Specs Version 2.1 / this ADR, **their configuration effort can be reduced**. They now only need to store the following information for each connection (down from 5 configuration properties to 3):
    1. URL to the `Pathfinder Discovery Configuration Document`
    2. Username & Password (as previously)
